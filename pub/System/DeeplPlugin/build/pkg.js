"use strict";!function(e){var t={source:null,target:null,swapper:null,sourceLang:"",targetLang:"",formality:"",autoSubmit:null};function n(e){return(e.data("natedit")?e.data("natedit").getValue():e.is("input")||e.is("select")||e.is("textarea")?e.val():e.html()).trim()}function o(e,t){e.data("natedit")?e.data("natedit").setValue(t):e.is("input")||e.is("select")||e.is("textarea")?e.val(t):e.html(t),e.trigger("change")}function r(n,o){var r=this;r.elem=e(n),r.opts=e.extend({},t,r.elem.data(),o),r.init()}r.prototype.init=function(){var t,n,o,r=this;if(r.opts.target=r.opts.target||r.opts.source,r.targetElem=e(r.opts.target),r.sourceElem=e(r.opts.source),2!==r.opts.sourceLang.length&&(r.sourceLangElem=e(r.opts.sourceLang)),2!==r.opts.targetLang.length&&(r.targetLangElem=e(r.opts.targetLang)),2!==r.opts.formality.length&&(r.formalityElem=e(r.opts.formality)),0==r.sourceElem.length)throw"source not found at "+r.opts.source;if(0==r.targetElem.length)throw"target not found at "+r.opts.target;r.opts.autoSubmit?(r.sourceElem.on("keyup",(t=function(){r.translate()},n=r.opts.autoSubmit,function(...e){clearTimeout(o),o=setTimeout((function(){clearTimeout(o),t(...e)}),n)})),r.sourceLangElem&&r.sourceLangElem.on("change",(function(){r.translate()})),r.targetLangElem&&r.targetLangElem.on("change",(function(){r.translate()})),r.formalityElem&&r.formalityElem.on("change",(function(){r.translate()}))):r.elem.on("click",(function(t){return e.blockUI({message:"<h1>"+e.i18n("Translating")+"...</h1>"}),r.translate().then((function(){e.unblockUI()})),r.elem.blur(),t.preventDefault(),!1})),r.opts.swapper&&(r.swapperElem=e(r.opts.swapper),r.swapperElem.on("click",(function(e){return r.swapSourceAndTarget(),e.preventDefault(),!1})))},r.prototype.reset=function(){var e=this;e.origText&&(o(e.sourceElem,e.origText),e._prevFingerPrint=void 0,e.origText=void 0)},r.prototype.swapSourceAndTarget=function(){var e=this,t=e.getSourceLang(),o=e.getTargetLang(),r=n(e.sourceElem),a=n(e.targetElem);e.targetLangElem.val(t),e.targetElem.val(r),e.sourceLangElem.val(o),e.sourceElem.val(a)},r.prototype.translate=function(){var t,r=this,a=n(r.sourceElem),i=r.getSourceLang(),l=r.getTargetLang(),s=r.getFormality(),u=e.Deferred();return!i&&!l||""===a?(console.log("not yet ready to translate"),u.resolve().promise()):(t=i+"::"+l+"::"+s+"::"+a,r._prevFingerPrint===t?(console.log("not translating the same thing twice"),u.resolve().promise()):(r._prevFingerPrint=t,r.hideMessages(),i===l?(o(r.targetElem,a),u.resolve(a)):foswiki.jsonRpc({namespace:"DeeplPlugin",method:"translate",params:{text:a,source_lang:i,target_lang:l,formality:s,tag_handling:"html",ignore_tags:"img"},beforeSend:function(){r.elem.block({message:""})},success:function(e){r.elem.unblock(),r.origText=a,o(r.targetElem,e.result),r.elem.trigger("success"),u.resolve(e.result)},error:function(e){r.elem.unblock(),r.elem.trigger("error"),r.showMessage("error",e.error.message),u.reject(e.error.message)}}),u.promise()))},r.prototype.getSourceLang=function(){var e=this;return e.sourceLangElem?e.sourceLangElem.val():e.opts.sourceLang},r.prototype.getTargetLang=function(){var e=this;return e.targetLangElem?e.targetLangElem.val():e.opts.targetLang},r.prototype.getFormality=function(){return this.formalityElem?this.formalityElem.val():"default"},r.prototype.showMessage=function(t,n,o){e.pnotify({title:o,text:n,hide:"error"!==t,type:t,sticker:!1,closer_hover:!1,delay:"error"===t?8e3:2e3})},r.prototype.hideMessages=function(){e.pnotify_remove_all()},e.fn.deepl=function(t){return this.each((function(){e.data(this,"deepl")||e.data(this,"deepl",new r(this,t))}))},e(".jqDeepl").livequery((function(){e(this).deepl()}))}(jQuery),function(e){function t(t,n){this.elem=e(t),this.init()}t.prototype.init=function(){var t=this;t.sourceLang=t.elem.prop("lang"),t.documentLang=e("html").prop("lang"),t.browserLang=navigator.language.replace(/\-.*$/,""),""!==t.sourceLang&&(t.sourceLang!==t.documentLang?t.targetLang=t.documentLang:t.sourceLang!==t.browserLang&&(t.targetLang=t.browserLang),t.targetLang&&(t.id="translatable_"+foswiki.getUniqueID(),t.elem.wrapInner("<div class='jqDeeplText' />"),t.elem.find(".jqDeeplText").prop("id",t.id).css("margin-bottom","1em"),t.deeplButton=e(`<a href="#" class="jqDeepl i18n foswikiGrayText" data-source="#${t.id}" data-target-lang="${t.targetLang}">Translate</a>`).appendTo(t.elem),t.undoButton=e('<a href="#" class="i18n foswikiGrayText" style="display:none">Show original</a>').appendTo(t.elem),t.deeplButton.on("success",(function(){t.deeplButton.hide(),t.undoButton.show()})),t.undoButton.on("click",(function(){return t.deeplButton.data("deepl").reset(),t.deeplButton.show(),t.undoButton.hide(),!1}))))},e.fn.deeplTranslatable=function(n){return this.each((function(){e.data(this,"deeplTranslatable")||e.data(this,"deeplTranslatable",new t(this,n))}))},e("div[lang]").livequery((function(){e(this).deeplTranslatable()}))}(jQuery),function(e){var t={source:null,target:null,swapper:null,formality:"",autoSubmit:null,block:!0,message:"Uploading ...",pollDelay:3e3};function n(n,o){var r=this;r.elem=e(n),r.opts=e.extend({},t,r.elem.data(),o),r.init()}n.prototype.init=function(){var e=this;e.keyElem=e.elem.find("input[name=validation_key]:first"),e.opts.autoSubmit&&e.elem.find("input[type=file]").on("change",(function(){e.elem.submit()})),e.elem.ajaxForm({beforeSerialize:function(){"undefined"!=typeof StrikeOne&&StrikeOne.submit(e.elem[0])},beforeSubmit:function(){if(void 0!==e.elem.data("validator")&&!e.elem.valid())return!1;e.block()},error:function(t){e.handleError(t.responseJSON)},success:function(t,n,o){var r,a;t.error?e.handleError(t):(r=t.result.document_key,a=t.result.document_id,e.wait(r,a).then((function(){e.download(r,a)})))},complete:function(t){var n=t.getResponseHeader("X-Foswiki-Validation");n&&e.keyElem.val("?"+n)}})},n.prototype.handleError=function(t){var n;this.unblock(),void 0===t||void 0===t.error?(n="Sorry, an error occurred.",console.error("responseText=",t)):(n=t.error.message,console.error("error=",n)),e.pnotify({type:"error",title:"Error",hide:0,text:n})},n.prototype.block=function(t){var n=this;n.opts.block&&(n.unblock(),t=t||n.opts.message,e.blockUI({message:n.opts.message?'<h1 id="blockUIMessage">'+t+"</h1>":""}))},n.prototype.unblock=function(){this.opts.block&&e.unblockUI()},n.prototype.wait=function(t,n,o){var r=this;return o=o||e.Deferred(),foswiki.jsonRpc({namespace:"DeeplPlugin",method:"status",params:{document_key:t,document_id:n}}).fail((function(e){r.handleError(e.responseJSON),o.reject()})).done((function(a){var i,l;if(a.error)return r.handleError(a),void o.reject();i=a.result.status,e("#blockUIMessage").html((l=i,String(l).charAt(0).toUpperCase()+String(l).slice(1)+" ...")),"done"===i?o.resolve():setTimeout((function(){r.wait(t,n,o)}),r.opts.pollDelay)})),o.promise()},n.prototype.download=function(e,t){var n=foswiki.getScriptUrl("rest","DeeplPlugin","download",{document_key:e,document_id:t});this.unblock(),window.location.href=n},e.fn.deeplDocument=function(t){return this.each((function(){e.data(this,"deeplDocument")||e.data(this,"deeplDocument",new n(this,t))}))},e(".jqDeeplDocument").livequery((function(){e(this).deeplDocument()}))}(jQuery);
